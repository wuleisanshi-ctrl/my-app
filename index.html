<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#0f1115">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="CalorieLens">
    <link rel="apple-touch-icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Crect width='100' height='100' rx='25' fill='%2310B981'/%3E%3Ctext x='50' y='65' font-family='Arial' font-size='50' text-anchor='middle' fill='white'%3ECL%3C/text%3E%3C/svg%3E">

    <title>CalorieLens Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&display=swap');
        :root { --safe-top: env(safe-area-inset-top); --safe-bottom: env(safe-area-inset-bottom); }
        body { font-family: 'Plus Jakarta Sans', sans-serif; background-color: #0f1115; color: white; overflow: hidden; overscroll-behavior: none; position: fixed; width: 100%; height: 100%; -webkit-tap-highlight-color: transparent; }
        .camera-view { height: 100vh; width: 100vw; background: linear-gradient(rgba(0,0,0,0.4), rgba(0,0,0,0.4)), url('https://images.unsplash.com/photo-1490645935967-10de6ba17061?auto=format&fit=crop&q=80&w=1000'); background-size: cover; background-position: center; position: relative; }
        .status-header { padding-top: calc(var(--safe-top) + 1rem); }
        .result-card { transform: translateY(100%); transition: transform 0.5s cubic-bezier(0.17, 0.84, 0.44, 1); padding-bottom: calc(var(--safe-bottom) + 1rem); }
        .result-card.show { transform: translateY(0); }
        .blur-bg { backdrop-filter: blur(24px); -webkit-backdrop-filter: blur(24px); background: rgba(28, 30, 35, 0.85); }
        .modal-overlay { background: rgba(0,0,0,0.8); backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px); display: none; }
        .btn-active:active { transform: scale(0.95); }
        .loading-dots:after { content: '.'; animation: dots 1s steps(5, end) infinite; }
        @keyframes dots { 0%, 20% { content: '.'; } 40% { content: '..'; } 60% { content: '...'; } 80%, 100% { content: ''; } }
    </style>
</head>
<body>

    <div class="camera-view" id="app">
        <!-- 顶部 -->
        <div class="absolute top-0 left-0 right-0 px-6 status-header flex justify-between items-start z-10">
            <div class="space-y-2">
                <div class="blur-bg px-4 py-2 rounded-2xl border border-white/10 flex items-center gap-2">
                    <div id="statusDot" class="w-2 h-2 bg-red-500 rounded-full"></div>
                    <span id="statusText" class="text-[10px] font-bold uppercase tracking-widest text-white/80">Connecting AI...</span>
                </div>
                <div class="blur-bg p-3 rounded-2xl border border-white/10">
                    <div class="text-[10px] text-white/40 uppercase font-bold">Today's Intake</div>
                    <div class="flex items-baseline gap-1">
                        <span id="todayTotal" class="text-xl font-black text-green-400">--</span>
                        <span class="text-xs text-white/40">kcal</span>
                    </div>
                </div>
            </div>
            <button onclick="toggleProfile()" class="w-12 h-12 rounded-2xl blur-bg flex items-center justify-center border border-white/10 text-xl btn-active">⚙️</button>
        </div>

        <!-- 扫描框 -->
        <div class="absolute inset-0 flex items-center justify-center pointer-events-none">
            <div id="target" class="w-64 h-64 border-2 border-white/20 rounded-[40px] relative"></div>
        </div>

        <!-- 扫码按钮 -->
        <div class="absolute bottom-12 left-0 right-0 px-10 flex justify-center items-center" style="padding-bottom: var(--safe-bottom);">
            <button onclick="startScan()" id="scanBtn" class="w-20 h-20 rounded-full border-4 border-white flex items-center justify-center p-1 transition-all btn-active">
                <div class="w-full h-full bg-white rounded-full"></div>
            </button>
        </div>

        <!-- 结果 -->
        <div id="resultCard" class="result-card absolute bottom-0 left-0 right-0 p-4 z-50">
            <div class="blur-bg rounded-[40px] p-8 border border-white/20 shadow-2xl relative">
                <div class="flex justify-between items-start mb-6">
                    <div>
                        <h2 class="text-3xl font-black mb-1" id="foodName">Scanning...</h2>
                        <p class="text-green-400 text-sm font-semibold">AI Neural Match Success</p>
                    </div>
                    <button onclick="closeResult()" class="w-10 h-10 flex items-center justify-center rounded-full bg-white/10 text-xl">&times;</button>
                </div>
                <div class="grid grid-cols-3 gap-3 mb-8 text-center text-sm">
                    <div class="p-4 bg-white/5 rounded-3xl border border-white/5"><div class="text-2xl font-black" id="calories">0</div><div>Kcal</div></div>
                    <div class="p-4 bg-white/5 rounded-3xl border border-white/5"><div class="text-2xl font-black" id="protein">0g</div><div>Protein</div></div>
                    <div class="p-4 bg-white/5 rounded-3xl border border-white/5"><div class="text-2xl font-black" id="fat">0g</div><div>Fat</div></div>
                </div>
                <button id="confirmBtn" onclick="confirmSave()" class="w-full bg-green-500 text-black font-black py-5 rounded-2xl shadow-lg btn-active text-lg">Confirm & Sync</button>
            </div>
        </div>

        <!-- 弹窗消息 (代替 Alert) -->
        <div id="toast" class="fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 blur-bg px-6 py-4 rounded-2xl border border-white/20 z-[200] hidden text-center">
            <p id="toastText" class="font-bold text-sm"></p>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, doc, setDoc, getDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        const firebaseConfig = JSON.parse(window.__firebase_config || '{}');
        const appId = window.__app_id || 'calorie-tracker-ios';
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        let currentUser = null;
        let currentScanData = null;

        // 统一提示
        function showMsg(txt) {
            const t = document.getElementById('toast');
            document.getElementById('toastText').innerText = txt;
            t.style.display = 'block';
            setTimeout(() => t.style.display = 'none', 3000);
        }

        // 状态监控
        const updateStatus = (isOk) => {
            const dot = document.getElementById('statusDot');
            const txt = document.getElementById('statusText');
            dot.className = isOk ? 'w-2 h-2 bg-green-500 rounded-full animate-pulse' : 'w-2 h-2 bg-red-500 rounded-full';
            txt.innerText = isOk ? 'AI Engine Online' : 'Connecting AI...';
        };

        // 认证
        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                updateStatus(true);
                loadUserData();
            } else {
                updateStatus(false);
                signInAnonymously(auth).catch(() => setTimeout(() => location.reload(), 3000));
            }
        });

        function loadUserData() {
            if (!currentUser) return;
            const dateStr = new Date().toISOString().split('T')[0];
            const dailyRef = doc(db, 'artifacts', appId, 'users', currentUser.uid, 'daily_logs', dateStr);
            onSnapshot(dailyRef, (snap) => {
                document.getElementById('todayTotal').innerText = snap.exists() ? (snap.data().totalKcal || 0) : 0;
            }, (err) => console.log("Stream error, retrying..."));
        }

        window.startScan = function() {
            const btn = document.getElementById('scanBtn');
            btn.disabled = true;
            btn.style.opacity = '0.5';
            
            setTimeout(() => {
                const mockFoods = [
                    { name: "Chicken Salad", kcal: 320, protein: 25, fat: 12 },
                    { name: "Avocado Toast", kcal: 450, protein: 12, fat: 28 },
                    { name: "Beef Steak", kcal: 580, protein: 45, fat: 35 }
                ];
                currentScanData = mockFoods[Math.floor(Math.random() * mockFoods.length)];
                document.getElementById('foodName').innerText = currentScanData.name;
                document.getElementById('calories').innerText = currentScanData.kcal;
                document.getElementById('protein').innerText = currentScanData.protein + 'g';
                document.getElementById('fat').innerText = currentScanData.fat + 'g';
                document.getElementById('resultCard').classList.add('show');
            }, 800);
        };

        window.confirmSave = async () => {
            if (!currentUser) {
                showMsg("Waiting for AI Engine...");
                return;
            }
            
            const btn = document.getElementById('confirmBtn');
            const originalText = btn.innerText;
            btn.innerText = "Syncing...";
            btn.disabled = true;

            const dateStr = new Date().toISOString().split('T')[0];
            const dailyRef = doc(db, 'artifacts', appId, 'users', currentUser.uid, 'daily_logs', dateStr);
            
            try {
                const snap = await getDoc(dailyRef);
                const currentTotal = snap.exists() ? (snap.data().totalKcal || 0) : 0;
                await setDoc(dailyRef, { 
                    totalKcal: currentTotal + currentScanData.kcal,
                    updatedAt: new Date().getTime()
                }, { merge: true });
                
                showMsg("Saved successfully!");
                closeResult();
            } catch (err) {
                showMsg("Sync failed. Check connection.");
                btn.innerText = "Retry Sync";
                btn.disabled = false;
            }
        };

        window.closeResult = () => {
            document.getElementById('resultCard').classList.remove('show');
            const sBtn = document.getElementById('scanBtn');
            sBtn.disabled = false;
            sBtn.style.opacity = '1';
        };

        window.toggleProfile = () => showMsg("Settings Profile coming soon...");

        // 首次打开检查环境
        window.onload = () => {
            const isSafari = /^((?!chrome|android).)*safari/i.test(navigator.userAgent);
            const isStandalone = window.navigator.standalone === true;
            if (!isSafari && !isStandalone) {
                showMsg("Please use Safari for the best experience!");
            }
        };
    </script>
</body>
</html>
