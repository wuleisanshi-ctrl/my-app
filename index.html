<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>AIå…¨èƒ½å¥åº·åŠ©æ‰‹</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root { --safe-top: env(safe-area-inset-top); --safe-bottom: env(safe-area-inset-bottom); }
        body { font-family: -apple-system, BlinkMacSystemFont, sans-serif; background-color: #000; color: white; overflow: hidden; position: fixed; width: 100%; height: 100%; }
        .page { position: absolute; inset: 0; transition: all 0.4s ease; display: flex; flex-direction: column; opacity: 0; pointer-events: none; }
        .page.active { opacity: 1; pointer-events: auto; }
        #video-stream { width: 100%; height: 100%; object-fit: cover; }
        .blur-card { backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); background: rgba(30, 32, 35, 0.7); border: 1px solid rgba(255,255,255,0.1); }
        .tab-bar { position: fixed; bottom: 0; left: 0; right: 0; height: calc(70px + var(--safe-bottom)); background: rgba(10, 10, 10, 0.8); backdrop-filter: blur(20px); display: flex; padding-bottom: var(--safe-bottom); z-index: 100; }
        .tab-item { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; color: #555; transition: 0.3s; }
        .tab-item.active { color: #10B981; }
        .panel { transform: translateY(100%); transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1); z-index: 110; }
        .panel.active { transform: translateY(0); }
        .loading-overlay { position: absolute; inset: 0; background: rgba(0,0,0,0.8); display: none; flex-direction: column; items: center; justify-content: center; z-index: 200; }
        .loading-overlay.active { display: flex; }
        .scan-anim { position: absolute; top: 0; left: 0; right: 0; height: 2px; background: #10B981; box-shadow: 0 0 15px #10B981; animation: scanMove 2s infinite; }
        @keyframes scanMove { 0% { top: 0; } 100% { top: 100%; } }
    </style>
</head>
<body>

    <!-- åŠ è½½é®ç½© -->
    <div id="loading" class="loading-overlay">
        <div class="w-12 h-12 border-4 border-green-500 border-t-transparent rounded-full animate-spin mb-4"></div>
        <p class="text-sm font-bold tracking-widest text-green-500 italic">AI æ­£åœ¨ç–¯ç‹‚è®¡ç®—çƒ­é‡...</p>
    </div>

    <!-- æ‘„åƒå¤´èƒŒæ™¯ -->
    <div class="absolute inset-0 z-0">
        <video id="video-stream" autoplay playsinline muted></video>
        <div class="absolute inset-0 bg-black/20"></div>
    </div>

    <!-- æ‰«æä¸»ç•Œé¢ -->
    <div id="scanPage" class="page active">
        <div class="p-6 pt-12 z-10 flex justify-between items-start">
            <div class="blur-card px-4 py-2 rounded-full text-[10px] font-bold uppercase tracking-widest text-green-400">AI Food Expert</div>
            <div class="blur-card p-4 rounded-3xl text-right">
                <div class="text-[10px] opacity-40 uppercase font-bold">Today</div>
                <div class="text-2xl font-black text-green-400"><span class="totalKcal">0</span> <small class="text-xs">KCAL</small></div>
            </div>
        </div>
        
        <div class="flex-1 flex items-center justify-center">
            <div class="w-64 h-64 border-2 border-white/20 rounded-[40px] relative overflow-hidden">
                <div id="scanLine" class="scan-anim hidden"></div>
            </div>
        </div>

        <div class="pb-32 flex justify-center">
            <button onclick="takeSnapshot()" class="w-20 h-20 rounded-full border-4 border-white p-1.5 transition active:scale-90 shadow-2xl">
                <div class="w-full h-full bg-white rounded-full"></div>
            </button>
        </div>
    </div>

    <!-- æ•°æ®æ—¥è®°é¡µ -->
    <div id="diaryPage" class="page bg-[#0a0a0a]">
        <div class="p-8 overflow-y-auto pb-32">
            <h2 class="text-4xl font-black italic uppercase mb-8 tracking-tighter">My Status</h2>
            <div class="blur-card p-8 rounded-[40px] mb-6 bg-gradient-to-br from-green-500/10 to-transparent">
                <p class="text-[10px] font-bold text-green-500 uppercase tracking-widest mb-2">Total Calories</p>
                <div class="text-6xl font-black mb-4 tracking-tighter"><span class="totalKcal">0</span></div>
                <div id="progContainer" class="w-full h-2 bg-white/5 rounded-full overflow-hidden">
                    <div id="progBar" class="h-full bg-green-500 w-0 transition-all duration-1000 shadow-[0_0_10px_#10B981]"></div>
                </div>
            </div>
            <div id="logs" class="space-y-4"></div>
        </div>
    </div>

    <!-- è¯†åˆ«ç»“æœé¢æ¿ -->
    <div id="resultPanel" class="panel fixed bottom-0 left-0 right-0 p-4">
        <div class="blur-card rounded-[48px] p-8 shadow-2xl border-white/10">
            <div class="text-center mb-8">
                <h3 id="foodName" class="text-3xl font-black mb-2 tracking-tight">-</h3>
                <span class="text-green-500 text-[10px] font-bold uppercase tracking-widest">AI æ·±åº¦åˆ†æç»“æœ</span>
            </div>
            <div class="grid grid-cols-3 gap-4 mb-8">
                <div class="bg-white/5 p-4 rounded-3xl text-center border border-white/5">
                    <div id="resKcal" class="text-xl font-black">-</div>
                    <div class="text-[9px] opacity-40 font-bold uppercase">Kcal</div>
                </div>
                <div class="bg-white/5 p-4 rounded-3xl text-center border border-white/5">
                    <div id="resPro" class="text-xl font-black">-</div>
                    <div class="text-[9px] opacity-40 font-bold uppercase">Pro</div>
                </div>
                <div class="bg-white/5 p-4 rounded-3xl text-center border border-white/5">
                    <div id="resFat" class="text-xl font-black">-</div>
                    <div class="text-[9px] opacity-40 font-bold uppercase">Fat</div>
                </div>
            </div>
            <button onclick="saveRecord()" class="w-full bg-green-500 text-black font-black py-5 rounded-3xl active:scale-95 transition text-lg shadow-lg">è®°å…¥å¥åº·æ—¥è®°</button>
            <button onclick="closePanel()" class="w-full mt-4 text-white/30 text-sm font-bold uppercase tracking-widest">æ”¾å¼ƒæœ¬æ¬¡è¯†åˆ«</button>
        </div>
    </div>

    <!-- å¯¼èˆªæ  -->
    <nav class="tab-bar border-t border-white/5">
        <div onclick="switchTab('scan')" id="t-scan" class="tab-item active">ğŸ<span class="text-[10px] font-black mt-1">è¯†åˆ«</span></div>
        <div onclick="switchTab('diary')" id="t-diary" class="tab-item">ğŸ“Š<span class="text-[10px] font-black mt-1">çœ‹æ¿</span></div>
    </nav>

    <canvas id="snapshotCanvas" class="hidden"></canvas>

    <script>
        // --- æ ¸å¿ƒé…ç½® ---
        // å·²åµŒå…¥æ‚¨æä¾›çš„ API Key
        const GEMINI_API_KEY = "AIzaSyDY1egGL6yvoMOoBAsRSbidytfphy-5D68";

        let logs = JSON.parse(localStorage.getItem('health_logs') || '[]');
        let currentResult = null;

        // æ‘„åƒå¤´åˆå§‹åŒ–
        async function initCamera() {
            const video = document.getElementById('video-stream');
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: "environment" }, 
                    audio: false 
                });
                video.srcObject = stream;
            } catch (e) {
                console.error("ç›¸æœºå¼€å¯å¤±è´¥:", e);
                alert("æ— æ³•è®¿é—®æ‘„åƒå¤´ï¼Œè¯·æ£€æŸ¥æƒé™è®¾ç½®");
            }
        }

        // æ‹ç…§å¹¶è°ƒç”¨ AI
        async function takeSnapshot() {
            const video = document.getElementById('video-stream');
            const canvas = document.getElementById('snapshotCanvas');
            const scanLine = document.getElementById('scanLine');
            const loading = document.getElementById('loading');

            // 1. æŠ“å–å›¾ç‰‡
            scanLine.classList.remove('hidden');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            canvas.getContext('2d').drawImage(video, 0, 0);
            
            // å‹ç¼©å›¾ç‰‡ä»¥åŠ å¿«ä¼ è¾“
            const base64Data = canvas.toDataURL('image/jpeg', 0.5).split(',')[1];

            loading.classList.add('active');

            // å®šä¹‰ç»™ AI çš„æŒ‡ä»¤
            const prompt = "è¯·ä½œä¸ºè¥å…»ä¸“å®¶è¯†åˆ«å›¾ä¸­çš„é£Ÿç‰©ã€‚è¯·åŠ¡å¿…è¯†åˆ«å‡ºå…·ä½“åç§°ã€‚ä»…è¿”å›JSONæ ¼å¼ï¼Œä¸è¦æœ‰ä»»ä½•å¤šä½™æ–‡å­—ï¼š{ \"name\": \"é£Ÿç‰©åç§°\", \"kcal\": çƒ­é‡æ•°å€¼, \"pro\": è›‹ç™½è´¨æ•°å€¼, \"fat\": è„‚è‚ªæ•°å€¼ }ã€‚å¦‚æœå›¾ä¸­æ²¡æœ‰é£Ÿç‰©ï¼Œè¯·è¿”å› { \"error\": true }";
            
            try {
                // è°ƒç”¨ Gemini 2.5 Flash API
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${GEMINI_API_KEY}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{
                            parts: [
                                { text: prompt },
                                { inlineData: { mimeType: "image/jpeg", data: base64Data } }
                            ]
                        }]
                    })
                });

                if (!response.ok) throw new Error("AI æœåŠ¡å™¨è¿æ¥å¤±è´¥");

                const result = await response.json();
                const text = result.candidates[0].content.parts[0].text;
                
                // æ¸…æ´— JSON å­—ç¬¦ä¸²
                const cleanJson = text.replace(/```json|```/g, '').trim();
                const data = JSON.parse(cleanJson);

                if(data.error) throw new Error("æ²¡è®¤å‡ºæ¥è¿™æ˜¯é£Ÿç‰©ï¼Œæ¢ä¸ªè§’åº¦è¯•è¯•ï¼Ÿ");

                // æ›´æ–°ç•Œé¢æ•°æ®
                currentResult = data;
                document.getElementById('foodName').innerText = data.name;
                document.getElementById('resKcal').innerText = data.kcal;
                document.getElementById('resPro').innerText = data.pro + 'g';
                document.getElementById('resFat').innerText = data.fat + 'g';
                document.getElementById('resultPanel').classList.add('active');

            } catch (err) {
                console.error(err);
                alert("è¯†åˆ«å‡ºé”™äº†: " + err.message);
            } finally {
                loading.classList.remove('active');
                scanLine.classList.add('hidden');
            }
        }

        // ä¿å­˜è®°å½•åˆ°æœ¬åœ°å­˜å‚¨
        function saveRecord() {
            if(!currentResult) return;
            const now = new Date();
            const timeStr = now.getHours().toString().padStart(2, '0') + ":" + now.getMinutes().toString().padStart(2, '0');
            
            logs.push({ ...currentResult, time: timeStr });
            localStorage.setItem('health_logs', JSON.stringify(logs));
            
            updateUI();
            closePanel();
            switchTab('diary');
        }

        // æ›´æ–°å…¨å±€ UI æ•°æ®
        function updateUI() {
            const total = logs.reduce((s, i) => s + i.kcal, 0);
            document.querySelectorAll('.totalKcal').forEach(el => el.innerText = total);
            
            // å‡è®¾æ¯æ—¥ç›®æ ‡ 2000 å¤§å¡
            const progress = Math.min((total / 2000) * 100, 100);
            document.getElementById('progBar').style.width = progress + '%';
            
            // æ¸²æŸ“åˆ—è¡¨
            const logBox = document.getElementById('logs');
            if (logs.length === 0) {
                logBox.innerHTML = `<div class="text-center py-20 opacity-20 font-bold uppercase tracking-widest text-sm">è¿˜æ²¡æœ‰æ‘„å…¥è®°å½•</div>`;
            } else {
                logBox.innerHTML = logs.slice().reverse().map(l => `
                    <div class="blur-card p-6 rounded-[32px] flex justify-between items-center border-l-4 border-green-500 bg-white/[0.02]">
                        <div>
                            <div class="font-black text-lg tracking-tight">${l.name}</div>
                            <div class="text-[10px] opacity-30 font-bold uppercase mt-1">${l.time}</div>
                        </div>
                        <div class="text-right">
                            <div class="text-2xl font-black text-green-400 tracking-tighter">${l.kcal}</div>
                            <div class="text-[9px] opacity-30 font-bold uppercase">Kcal</div>
                        </div>
                    </div>
                `).join('');
            }
        }

        // é¡µé¢åˆ‡æ¢
        function switchTab(id) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.tab-item').forEach(t => t.classList.remove('active'));
            document.getElementById(id + 'Page').classList.add('active');
            document.getElementById('t-' + id).classList.add('active');
            if(id === 'diary') updateUI();
        }

        function closePanel() { 
            document.getElementById('resultPanel').classList.remove('active'); 
        }

        // å¯åŠ¨
        window.onload = () => {
            initCamera();
            updateUI();
        };
    </script>
</body>
</html>
