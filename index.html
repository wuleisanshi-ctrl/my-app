<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>AI健康助手 - 高级视觉版</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root { --safe-top: env(safe-area-inset-top); --safe-bottom: env(safe-area-inset-bottom); }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #000; color: white; overflow: hidden; position: fixed; width: 100%; height: 100%; }
        
        /* 这里的 UI 风格参考了用户提供的截图 */
        .glass-panel { background: rgba(28, 28, 30, 0.95); backdrop-filter: blur(20px); border: 1px solid rgba(255,255,255,0.1); }
        .action-btn { background: #22C55E; color: black; font-weight: 800; transition: all 0.2s; }
        .action-btn:active { transform: scale(0.96); opacity: 0.9; }
        
        #video-stream { width: 100%; height: 100%; object-fit: cover; }
        
        .tab-item { color: #888; transition: 0.3s; }
        .tab-item.active { color: #fff; }

        /* 模拟截图中的卡片样式 */
        .metric-card { background: rgba(255,255,255,0.05); border-radius: 32px; padding: 20px; text-align: center; }
        .metric-value { font-size: 28px; font-weight: 900; letter-spacing: -1px; }
        .metric-label { font-size: 10px; opacity: 0.4; font-weight: bold; margin-top: 4px; }

        .loading-pulse { animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: .5; } }
    </style>
</head>
<body>

    <!-- 顶栏状态 -->
    <div class="fixed top-0 left-0 right-0 p-6 pt-12 z-50 flex justify-between items-start pointer-events-none">
        <div class="pointer-events-auto">
            <div class="glass-panel px-4 py-2 rounded-full flex items-center gap-2">
                <div class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></div>
                <span class="text-[10px] font-bold tracking-widest uppercase">AI 食物模式</span>
            </div>
        </div>
        <div class="pointer-events-auto text-right">
            <div class="glass-panel px-6 py-3 rounded-3xl">
                <div class="text-[9px] opacity-40 font-bold uppercase tracking-wider mb-1">今日累计</div>
                <div class="text-2xl font-black text-green-400"><span id="totalKcal">0</span> <small class="text-xs opacity-50 uppercase font-normal">Kcal</small></div>
            </div>
        </div>
    </div>

    <!-- 摄像头背景 -->
    <div class="absolute inset-0 z-0">
        <video id="video-stream" autoplay playsinline muted></video>
        <div class="absolute inset-0 bg-gradient-to-b from-black/20 via-transparent to-black/80"></div>
    </div>

    <!-- 拍摄扫描区 -->
    <div id="scanView" class="absolute inset-0 flex flex-col items-center justify-end pb-32 z-10">
        <div class="mb-10 text-center">
            <div class="w-64 h-64 border-2 border-white/20 rounded-[60px] relative">
                <div id="scanLine" class="absolute inset-x-0 h-1 bg-green-500 shadow-[0_0_15px_#22C55E] hidden"></div>
            </div>
        </div>
        <button onclick="capture()" class="relative group">
            <div class="absolute inset-0 bg-green-500/20 rounded-full blur-xl group-active:scale-90 transition"></div>
            <div class="w-20 h-20 rounded-full border-4 border-white p-1 relative z-10">
                <div class="w-full h-full bg-white rounded-full flex items-center justify-center active:scale-90 transition">
                </div>
            </div>
        </button>
    </div>

    <!-- 结果面板 (参考用户截图修改) -->
    <div id="resultPanel" class="fixed inset-0 z-[100] bg-black/60 backdrop-blur-sm hidden flex items-end p-4">
        <div class="glass-panel w-full rounded-[48px] p-8 pb-12 transition-transform translate-y-full" id="resultCard">
            <div class="flex justify-between items-start mb-8">
                <div>
                    <h2 id="foodName" class="text-4xl font-black tracking-tight mb-2 italic">识别中...</h2>
                    <div class="text-green-500 text-[10px] font-bold tracking-[0.2em] uppercase">AI 食物识别成功</div>
                </div>
                <button onclick="hideResult()" class="w-10 h-10 rounded-full bg-white/5 flex items-center justify-center text-xl">✕</button>
            </div>

            <div class="grid grid-cols-3 gap-3 mb-10">
                <div class="metric-card">
                    <div id="kcalVal" class="metric-value">0</div>
                    <div class="metric-label italic">热量</div>
                </div>
                <div class="metric-card">
                    <div id="proVal" class="metric-value">0g</div>
                    <div class="metric-label italic">蛋白质</div>
                </div>
                <div class="metric-card">
                    <div id="fatVal" class="metric-value">0g</div>
                    <div class="metric-label italic">脂肪</div>
                </div>
            </div>

            <button onclick="saveToLog()" class="action-btn w-full py-6 rounded-[32px] text-lg mb-4 shadow-xl shadow-green-500/10">记入饮食日记</button>
            <button onclick="hideResult()" class="w-full text-center text-white/20 text-[10px] font-bold uppercase tracking-widest">取消</button>
        </div>
    </div>

    <!-- 配置中心 -->
    <div id="configPanel" class="fixed inset-0 z-[200] bg-black p-8 flex flex-col hidden">
        <div class="mt-12 mb-12">
            <h1 class="text-4xl font-black italic mb-2 tracking-tighter">火山方舟配置</h1>
            <p class="text-white/40 text-sm">填入你截图里的 API Key 和 模型 ID</p>
        </div>
        <div class="space-y-8 flex-1">
            <div class="group">
                <label class="text-[10px] font-bold opacity-30 uppercase tracking-widest mb-3 block">接入点 ID / 模型 ID</label>
                <input id="epId" type="text" spellcheck="false" class="w-full bg-white/5 border-b-2 border-white/10 p-4 outline-none focus:border-green-500 transition text-lg" placeholder="doubao-seed-1-8-251228">
            </div>
            <div class="group">
                <label class="text-[10px] font-bold opacity-30 uppercase tracking-widest mb-3 block">API Key</label>
                <input id="apiKey" type="password" spellcheck="false" class="w-full bg-white/5 border-b-2 border-white/10 p-4 outline-none focus:border-green-500 transition text-lg" placeholder="bd52daf8-...">
            </div>
        </div>
        <button onclick="saveConfig()" class="action-btn w-full py-6 rounded-full text-xl mb-10">保存并开始</button>
    </div>

    <!-- 设置按钮 -->
    <button onclick="showConfig()" class="fixed bottom-32 right-6 z-50 w-12 h-12 rounded-2xl glass-panel flex items-center justify-center text-xl">⚙️</button>

    <canvas id="output" class="hidden"></canvas>

    <script>
        let logs = JSON.parse(localStorage.getItem('f_logs') || '[]');
        let currentData = null;

        function showConfig() { document.getElementById('configPanel').classList.remove('hidden'); }
        function hideConfig() { document.getElementById('configPanel').classList.add('hidden'); }

        function saveConfig() {
            localStorage.setItem('f_ep', document.getElementById('epId').value.trim());
            localStorage.setItem('f_key', document.getElementById('apiKey').value.trim());
            hideConfig();
            initCamera();
        }

        async function initCamera() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
                document.getElementById('video-stream').srcObject = stream;
            } catch (e) { alert("请允许摄像头权限"); }
        }

        async function capture() {
            const ep = localStorage.getItem('f_ep');
            const key = localStorage.getItem('f_key');
            if(!ep || !key) { showConfig(); return; }

            const video = document.getElementById('video-stream');
            const canvas = document.getElementById('output');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            canvas.getContext('2d').drawImage(video, 0, 0);
            const base64 = canvas.toDataURL('image/jpeg', 0.5).split(',')[1];

            document.getElementById('scanLine').classList.remove('hidden');
            
            try {
                const res = await fetch('https://ark.cn-beijing.volces.com/api/v3/chat/completions', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${key}` },
                    body: JSON.stringify({
                        model: ep,
                        messages: [{
                            role: "user",
                            content: [
                                { type: "text", text: "识别图中食物，仅返回JSON: {\"name\":\"名称\",\"kcal\":数值,\"pro\":数值,\"fat\":数值}" },
                                { type: "image_url", image_url: { url: `data:image/jpeg;base64,${base64}` } }
                            ]
                        }]
                    })
                });

                const data = await res.json();
                if(data.error) throw new Error(data.error.message);
                
                const content = data.choices[0].message.content;
                const json = JSON.parse(content.match(/\{.*?\}/s)[0]);
                
                showResult(json);
            } catch (e) {
                alert("识别出错了: " + e.message);
            } finally {
                document.getElementById('scanLine').classList.add('hidden');
            }
        }

        function showResult(data) {
            currentData = data;
            document.getElementById('foodName').innerText = data.name;
            document.getElementById('kcalVal').innerText = data.kcal;
            document.getElementById('proVal').innerText = data.pro + 'g';
            document.getElementById('fatVal').innerText = data.fat + 'g';
            
            const panel = document.getElementById('resultPanel');
            const card = document.getElementById('resultCard');
            panel.classList.remove('hidden');
            setTimeout(() => card.style.transform = 'translateY(0)', 10);
        }

        function hideResult() {
            const card = document.getElementById('resultCard');
            card.style.transform = 'translateY(100%)';
            setTimeout(() => document.getElementById('resultPanel').classList.add('hidden'), 300);
        }

        function saveToLog() {
            logs.push({ ...currentData, time: new Date().toLocaleTimeString() });
            localStorage.setItem('f_logs', JSON.stringify(logs));
            updateTotal();
            hideResult();
        }

        function updateTotal() {
            const total = logs.reduce((acc, curr) => acc + (curr.kcal || 0), 0);
            document.getElementById('totalKcal').innerText = total;
        }

        window.onload = () => {
            document.getElementById('epId').value = localStorage.getItem('f_ep') || "";
            document.getElementById('apiKey').value = localStorage.getItem('f_key') || "";
            if(!localStorage.getItem('f_key')) showConfig();
            initCamera();
            updateTotal();
        }
    </script>
</body>
</html>
