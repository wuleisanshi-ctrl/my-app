<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>AI健康助手 - 火山方舟直连版</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root { --safe-top: env(safe-area-inset-top); --safe-bottom: env(safe-area-inset-bottom); }
        body { font-family: system-ui, -apple-system, sans-serif; background-color: #000; color: white; overflow: hidden; position: fixed; width: 100%; height: 100%; }
        .glass { background: rgba(30, 30, 35, 0.85); backdrop-filter: blur(25px); -webkit-backdrop-filter: blur(25px); border: 1px solid rgba(255,255,255,0.1); }
        .action-btn { background: #10B981; color: black; font-weight: 900; letter-spacing: -0.025em; }
        #video-stream { width: 100%; height: 100%; object-fit: cover; }
        .scan-line { position: absolute; left: 0; right: 0; height: 2px; background: #10B981; box-shadow: 0 0 20px #10B981; animation: scan 2.5s infinite linear; }
        @keyframes scan { from { top: 15%; } to { top: 85%; } }
        .loading-ring { border: 3px solid rgba(16, 185, 129, 0.2); border-top: 3px solid #10B981; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <!-- 顶部状态栏 -->
    <div class="fixed top-0 left-0 right-0 p-6 pt-12 z-50 flex justify-between items-start pointer-events-none">
        <div class="pointer-events-auto">
            <div class="glass px-4 py-2 rounded-full flex items-center gap-2">
                <div class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></div>
                <span class="text-[10px] font-bold tracking-widest uppercase text-green-400">Ark Engine V3</span>
            </div>
        </div>
        <div class="pointer-events-auto">
            <div class="glass p-4 rounded-[24px] min-w-[100px] text-right">
                <div class="text-[9px] opacity-40 font-bold uppercase mb-1">今日消耗</div>
                <div class="text-2xl font-black text-green-400 leading-none"><span id="totalKcal">0</span> <small class="text-[10px] font-normal opacity-60">kcal</small></div>
            </div>
        </div>
    </div>

    <!-- 实时视频预览 -->
    <div class="absolute inset-0 z-0 bg-zinc-900">
        <video id="video-stream" autoplay playsinline muted></video>
        <div class="absolute inset-0 bg-gradient-to-b from-black/50 via-transparent to-black/80"></div>
    </div>

    <!-- 核心操作区 -->
    <div id="mainUI" class="absolute inset-0 flex flex-col items-center justify-end pb-32 z-10">
        <div class="mb-12 relative">
            <div class="w-64 h-64 border border-white/10 rounded-[56px] relative overflow-hidden bg-white/5">
                <div id="scanIndicator" class="scan-line hidden"></div>
                <!-- 居中加载提示 -->
                <div id="loadingOverlay" class="absolute inset-0 flex items-center justify-center bg-black/40 hidden">
                    <div class="loading-ring"></div>
                </div>
            </div>
        </div>
        <button id="shutterBtn" onclick="processAnalysis()" class="relative active:scale-90 transition-transform duration-100">
            <div class="w-20 h-20 rounded-full border-[6px] border-white/30 p-1">
                <div class="w-full h-full bg-white rounded-full"></div>
            </div>
        </button>
    </div>

    <!-- 配置中心 -->
    <div id="configPanel" class="fixed inset-0 z-[200] bg-black p-8 flex flex-col hidden">
        <div class="mt-16 mb-12">
            <h2 class="text-4xl font-black italic tracking-tighter uppercase mb-2 text-green-500">Ark Setup</h2>
            <p class="text-zinc-500 text-xs">国内环境直连：请输入火山方舟接入点 ID</p>
        </div>
        <div class="space-y-10 flex-1">
            <div class="relative">
                <label class="text-[10px] font-bold opacity-30 uppercase tracking-widest mb-4 block">接入点 ID (EP-ID)</label>
                <input id="epInput" type="text" class="w-full bg-transparent border-b-2 border-white/10 py-3 text-lg outline-none focus:border-green-500 transition-colors" placeholder="ep-2025xxxxxx">
            </div>
            <div class="relative">
                <label class="text-[10px] font-bold opacity-30 uppercase tracking-widest mb-4 block">API Key</label>
                <input id="keyInput" type="password" class="w-full bg-transparent border-b-2 border-white/10 py-3 text-lg outline-none focus:border-green-500 transition-colors" placeholder="填入你截图中的Key">
            </div>
        </div>
        <button onclick="saveSettings()" class="action-btn w-full py-6 rounded-full text-xl mb-12 shadow-2xl shadow-green-500/20">保存并进入</button>
    </div>

    <!-- 结果详情卡片 -->
    <div id="resultPanel" class="fixed inset-0 z-[100] bg-black/70 backdrop-blur-sm hidden flex items-end p-4">
        <div id="resultCard" class="glass w-full rounded-[48px] p-8 pb-12 translate-y-full transition-transform duration-500">
            <div class="flex justify-between items-start mb-8">
                <div>
                    <h3 id="foodName" class="text-4xl font-black italic mb-1 tracking-tight italic">识别结果</h3>
                    <span class="text-green-500 text-[10px] font-bold tracking-widest">ARK VISION ANALYSIS</span>
                </div>
                <button onclick="hidePanel()" class="w-10 h-10 rounded-full bg-white/5 flex items-center justify-center text-zinc-500">✕</button>
            </div>
            <div class="grid grid-cols-3 gap-3 mb-10">
                <div class="bg-white/5 p-6 rounded-[32px] text-center border border-white/5">
                    <div id="resKcal" class="text-3xl font-black">0</div>
                    <div class="text-[9px] opacity-30 font-bold uppercase mt-1">Kcal</div>
                </div>
                <div class="bg-white/5 p-6 rounded-[32px] text-center border border-white/5">
                    <div id="resPro" class="text-2xl font-black">0g</div>
                    <div class="text-[9px] opacity-30 font-bold uppercase mt-1">Pro</div>
                </div>
                <div class="bg-white/5 p-6 rounded-[32px] text-center border border-white/5">
                    <div id="resFat" class="text-2xl font-black">0g</div>
                    <div class="text-[9px] opacity-30 font-bold uppercase mt-1">Fat</div>
                </div>
            </div>
            <button onclick="confirmEntry()" class="action-btn w-full py-6 rounded-[32px] text-lg">保存至日记</button>
        </div>
    </div>

    <button onclick="showConfig()" class="fixed bottom-32 right-6 z-50 w-12 h-12 glass rounded-2xl flex items-center justify-center text-xl">⚙️</button>
    <canvas id="tempCanvas" class="hidden"></canvas>

    <script>
        let logs = JSON.parse(localStorage.getItem('ark_logs') || '[]');
        let currentResult = null;

        async function initCamera() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: { facingMode: 'environment', width: { ideal: 1080 } }
                });
                document.getElementById('video-stream').srcObject = stream;
            } catch (e) { alert("请允许摄像头权限以使用识别功能"); }
        }

        function showConfig() { document.getElementById('configPanel').classList.remove('hidden'); }
        function hideConfig() { document.getElementById('configPanel').classList.add('hidden'); }

        function saveSettings() {
            localStorage.setItem('v_ep', document.getElementById('epInput').value.trim());
            localStorage.setItem('v_key', document.getElementById('keyInput').value.trim());
            hideConfig();
            initCamera();
        }

        async function processAnalysis() {
            const ep = localStorage.getItem('v_ep');
            const key = localStorage.getItem('v_key');
            if(!ep || !key) return showConfig();

            const video = document.getElementById('video-stream');
            const canvas = document.getElementById('tempCanvas');
            const ctx = canvas.getContext('2d');
            
            // 拍照处理
            canvas.width = 640;
            canvas.height = (640 / video.videoWidth) * video.videoHeight;
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
            const base64 = canvas.toDataURL('image/jpeg', 0.7).split(',')[1];

            // 动画状态
            document.getElementById('scanIndicator').classList.remove('hidden');
            document.getElementById('loadingOverlay').classList.remove('hidden');
            document.getElementById('shutterBtn').disabled = true;

            try {
                // 重点：火山方舟直连请求
                const response = await fetch('https://ark.cn-beijing.volces.com/api/v3/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + key.trim()
                    },
                    body: JSON.stringify({
                        model: ep,
                        messages: [{
                            role: "user",
                            content: [
                                { type: "text", text: "识别图中的食物。仅返回JSON：{\"name\":\"食物名\",\"kcal\":数值,\"pro\":数值,\"fat\":数值}。不要任何markdown标签或多余解释。" },
                                { type: "image_url", image_url: { url: "data:image/jpeg;base64," + base64 } }
                            ]
                        }]
                    })
                });

                if (!response.ok) {
                    const errTxt = await response.text();
                    throw new Error(`Server Error: ${response.status}\n${errTxt}`);
                }

                const data = await response.json();
                const content = data.choices[0].message.content;
                const json = JSON.parse(content.match(/\{.*?\}/s)[0]);
                
                showPanel(json);
            } catch (err) {
                console.error(err);
                if (err.message.includes('Failed to fetch') || err.name === 'TypeError') {
                    alert("⚠️ 加载失败 (Load Failed)\n\n原因：浏览器安全拦截（跨域限制）。\n解决：如果你是在电脑端调试，请开启允许跨域的浏览器设置。如果你是在手机端，请尝试将此网页部署到支持 HTTPS 的正式服务器上运行。");
                } else {
                    alert("发生错误: " + err.message);
                }
            } finally {
                document.getElementById('scanIndicator').classList.add('hidden');
                document.getElementById('loadingOverlay').classList.add('hidden');
                document.getElementById('shutterBtn').disabled = false;
            }
        }

        function showPanel(data) {
            currentResult = data;
            document.getElementById('foodName').innerText = data.name;
            document.getElementById('resKcal').innerText = data.kcal;
            document.getElementById('resPro').innerText = data.pro + 'g';
            document.getElementById('resFat').innerText = data.fat + 'g';
            document.getElementById('resultPanel').classList.remove('hidden');
            setTimeout(() => document.getElementById('resultCard').style.transform = 'translateY(0)', 10);
        }

        function hidePanel() {
            document.getElementById('resultCard').style.transform = 'translateY(100%)';
            setTimeout(() => document.getElementById('resultPanel').classList.add('hidden'), 400);
        }

        function confirmEntry() {
            logs.push({ ...currentResult, time: Date.now() });
            localStorage.setItem('ark_logs', JSON.stringify(logs));
            updateTotal();
            hidePanel();
        }

        function updateTotal() {
            const today = new Date().toDateString();
            const total = logs.filter(l => new Date(l.time).toDateString() === today)
                              .reduce((s, i) => s + (Number(i.kcal) || 0), 0);
            document.getElementById('totalKcal').innerText = total;
        }

        window.onload = () => {
            document.getElementById('epInput').value = localStorage.getItem('v_ep') || "";
            document.getElementById('keyInput').value = localStorage.getItem('v_key') || "";
            initCamera();
            updateTotal();
        }
    </script>
</body>
</html>
