<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>AIå¥åº·åŠ©æ‰‹ - ç²¾å‡†çƒ­é‡ç‰ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root { --safe-top: env(safe-area-inset-top); --safe-bottom: env(safe-area-inset-bottom); }
        body { font-family: system-ui, -apple-system, sans-serif; background-color: #000; color: white; overflow: hidden; position: fixed; width: 100%; height: 100%; }
        .glass { background: rgba(30, 30, 35, 0.85); backdrop-filter: blur(25px); -webkit-backdrop-filter: blur(25px); border: 1px solid rgba(255,255,255,0.1); }
        .action-btn { background: #10B981; color: black; font-weight: 900; letter-spacing: -0.025em; }
        #video-stream { width: 100%; height: 100%; object-fit: cover; }
        .scan-line { position: absolute; left: 0; right: 0; height: 2px; background: #10B981; box-shadow: 0 0 20px #10B981; animation: scan 2.5s infinite linear; }
        @keyframes scan { from { top: 15%; } to { top: 85%; } }
        .tab-bar { position: fixed; bottom: 0; left: 0; right: 0; height: calc(80px + var(--safe-bottom)); background: rgba(10, 10, 10, 0.9); backdrop-filter: blur(20px); display: flex; padding-bottom: var(--safe-bottom); z-index: 100; border-top: 1px solid rgba(255,255,255,0.05); }
        .tab-item { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; color: #666; transition: 0.3s; }
        .tab-item.active { color: #10B981; }
        .page { position: absolute; inset: 0; opacity: 0; pointer-events: none; transition: 0.4s; }
        .page.active { opacity: 1; pointer-events: auto; }
        
        /* è‡ªå®šä¹‰æ»‘åŠ¨æ¡æ ·å¼ */
        input[type=range] { -webkit-appearance: none; width: 100%; background: transparent; }
        input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 6px; background: rgba(255,255,255,0.1); border-radius: 3px; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; height: 24px; width: 24px; border-radius: 50%; background: #10B981; margin-top: -9px; box-shadow: 0 0 10px rgba(16,185,129,0.5); }
    </style>
</head>
<body class="mode-diet">

    <!-- é¡¶éƒ¨çŠ¶æ€æ  -->
    <div class="fixed top-0 left-0 right-0 p-6 pt-12 z-50 flex justify-between items-start pointer-events-none">
        <div class="pointer-events-auto flex flex-col gap-2">
            <div id="modeIndicator" class="glass px-4 py-2 rounded-full flex items-center gap-2">
                <div class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></div>
                <span id="modeText" class="text-[10px] font-bold tracking-widest uppercase text-green-400">Diet Mode</span>
            </div>
            <div class="flex gap-2">
                <button onclick="setMode('diet')" class="glass px-3 py-1 rounded-full text-[9px] font-bold uppercase">é¥®é£Ÿè¯†åˆ«</button>
                <button onclick="setMode('workout')" class="glass px-3 py-1 rounded-full text-[9px] font-bold uppercase">å™¨æ¢°æŒ‡å—</button>
            </div>
        </div>
        <div class="pointer-events-auto flex flex-col gap-2 text-right">
            <div class="glass p-4 rounded-[24px] min-w-[110px]">
                <div class="text-[9px] opacity-40 font-bold uppercase mb-1">ä»Šæ—¥å·²æ‘„å…¥</div>
                <div class="text-2xl font-black text-green-400 leading-none"><span class="totalKcal">0</span> <small class="text-[10px] font-normal opacity-60">kcal</small></div>
            </div>
            <div class="glass p-3 rounded-[20px]">
                <div class="text-[9px] opacity-40 font-bold uppercase mb-1">å¾…æ¶ˆè€—</div>
                <div class="text-lg font-black text-orange-400 leading-none"><span id="remainKcal">2000</span></div>
            </div>
        </div>
    </div>

    <!-- æ‰«æé¡µé¢ -->
    <div id="scanPage" class="page active">
        <div class="absolute inset-0 z-0 bg-zinc-900">
            <video id="video-stream" autoplay playsinline muted class="w-full h-full object-cover"></video>
            <div class="absolute inset-0 bg-gradient-to-b from-black/50 via-transparent to-black/80"></div>
        </div>
        <div class="absolute inset-0 flex flex-col items-center justify-end pb-40 z-10">
            <div class="mb-12 relative">
                <div class="w-64 h-64 border border-white/20 rounded-[56px] relative overflow-hidden bg-white/5">
                    <div id="scanIndicator" class="scan-line hidden"></div>
                    <div id="loadingOverlay" class="absolute inset-0 flex items-center justify-center bg-black/40 hidden">
                        <div class="flex flex-col items-center gap-3">
                            <div class="w-8 h-8 border-2 border-green-500 border-t-transparent rounded-full animate-spin"></div>
                            <span class="text-[10px] font-bold text-green-500 uppercase">AI Analyzing...</span>
                        </div>
                    </div>
                </div>
            </div>
            <button onclick="processAnalysis()" class="relative active:scale-90 transition-transform">
                <div class="w-20 h-20 rounded-full border-[6px] border-white/30 p-1">
                    <div class="w-full h-full bg-white rounded-full"></div>
                </div>
            </button>
        </div>
    </div>

    <!-- æ—¥è®°è®°å½•é¡µé¢ -->
    <div id="logPage" class="page bg-[#0a0a0a] z-40 overflow-y-auto pt-32 pb-32">
        <div class="px-8">
            <h2 class="text-4xl font-black italic uppercase mb-2">Health Log</h2>
            <p class="text-zinc-500 text-xs mb-8">ç²¾å‡†è¿½è¸ªæ¯ä¸€ä»½æ‘„å…¥</p>
            <div id="logContainer" class="space-y-4"></div>
        </div>
    </div>

    <!-- ç»“æœä¸é‡é‡é€‰æ‹©é¢æ¿ -->
    <div id="resultPanel" class="fixed inset-0 z-[100] bg-black/80 backdrop-blur-md hidden flex items-end">
        <div id="resultCard" class="glass w-full rounded-t-[48px] p-8 pb-12 translate-y-full transition-transform duration-500">
            <div class="flex justify-between items-start mb-6">
                <div>
                    <h3 id="resTitle" class="text-3xl font-black italic mb-1 tracking-tight">è¯†åˆ«ç»“æœ</h3>
                    <span id="resSub" class="text-green-500 text-[10px] font-bold tracking-widest uppercase">ARK PRECISION CALC</span>
                </div>
                <button onclick="hidePanel()" class="w-10 h-10 rounded-full bg-white/5 flex items-center justify-center">âœ•</button>
            </div>
            
            <!-- é¥®é£Ÿæ¨¡å¼ç‰¹æœ‰ï¼šé‡é‡é€‰æ‹©å™¨ -->
            <div id="dietDetails" class="space-y-8 mb-8">
                <div class="flex items-center justify-between px-2">
                    <span class="text-zinc-400 font-bold uppercase text-xs italic">è°ƒèŠ‚é‡é‡ (G)</span>
                    <span id="weightValue" class="text-3xl font-black text-green-400">200<small class="text-sm ml-1 opacity-50">g</small></span>
                </div>
                <input type="range" id="weightSlider" min="10" max="1000" step="10" value="200" oninput="updateCalculatedKcal(this.value)">
                
                <div class="grid grid-cols-3 gap-3">
                    <div class="bg-white/5 p-4 rounded-3xl text-center border border-white/5">
                        <div id="resKcal" class="text-2xl font-black">0</div>
                        <div class="text-[9px] opacity-30 font-bold uppercase mt-1">Total Kcal</div>
                    </div>
                    <div class="bg-white/5 p-4 rounded-3xl text-center border border-white/5">
                        <div id="resPro" class="text-xl font-black">0g</div>
                        <div class="text-[9px] opacity-30 font-bold uppercase mt-1">Protein</div>
                    </div>
                    <div class="bg-white/5 p-4 rounded-3xl text-center border border-white/5">
                        <div id="resFat" class="text-xl font-black">0g</div>
                        <div class="text-[9px] opacity-30 font-bold uppercase mt-1">Fat</div>
                    </div>
                </div>
            </div>

            <!-- å™¨æ¢°æ¨¡å¼ç‰¹æœ‰ -->
            <div id="workoutDetails" class="hidden mb-8">
                <div class="bg-white/5 p-6 rounded-3xl border border-white/5 italic opacity-80 leading-relaxed" id="resGuide"></div>
            </div>

            <button onclick="confirmEntry()" class="action-btn w-full py-6 rounded-[32px] text-lg">ç¡®è®¤è®°å½•</button>
        </div>
    </div>

    <!-- é…ç½®ä¸­å¿ƒ -->
    <div id="configPanel" class="fixed inset-0 z-[200] bg-black p-8 flex flex-col hidden">
        <div class="mt-20 mb-12"><h2 class="text-4xl font-black text-green-500 italic uppercase">Setup</h2></div>
        <div class="space-y-8 flex-1">
            <input id="epInput" type="text" class="w-full bg-transparent border-b border-white/10 py-4 outline-none focus:border-green-500" placeholder="æ¥å…¥ç‚¹ EP-ID">
            <input id="keyInput" type="password" class="w-full bg-transparent border-b border-white/10 py-4 outline-none focus:border-green-500" placeholder="API Key">
            <input id="goalInput" type="number" class="w-full bg-transparent border-b border-white/10 py-4 outline-none focus:border-green-500" placeholder="æ¯æ—¥ç›®æ ‡ (é»˜è®¤2000)">
        </div>
        <button onclick="saveSettings()" class="action-btn w-full py-6 rounded-full text-xl mb-12">å®Œæˆé…ç½®</button>
    </div>

    <!-- åº•éƒ¨å¯¼èˆª -->
    <nav class="tab-bar">
        <div onclick="switchTab('scan')" id="tab-scan" class="tab-item active">ğŸ“¸<span class="text-[10px] font-bold mt-1 uppercase">Scan</span></div>
        <div onclick="switchTab('log')" id="tab-log" class="tab-item">ğŸ“Š<span class="text-[10px] font-bold mt-1 uppercase">Log</span></div>
        <div onclick="showConfig()" class="tab-item">âš™ï¸<span class="text-[10px] font-bold mt-1 uppercase">Set</span></div>
    </nav>

    <canvas id="tempCanvas" class="hidden"></canvas>

    <script>
        let logs = JSON.parse(localStorage.getItem('ark_health_logs') || '[]');
        let currentResult = null; // å­˜å‚¨AIè¿”å›çš„å•ä»·æ•°æ®
        let currentMode = 'diet';

        async function initCamera() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
                document.getElementById('video-stream').srcObject = stream;
            } catch (e) { console.error(e); }
        }

        function setMode(mode) {
            currentMode = mode;
            document.getElementById('modeText').innerText = mode === 'diet' ? "Diet Mode" : "Workout Mode";
            document.getElementById('modeIndicator').querySelector('div').className = mode === 'diet' ? "w-2 h-2 bg-green-500 rounded-full animate-pulse" : "w-2 h-2 bg-blue-500 rounded-full animate-pulse";
        }

        async function processAnalysis() {
            const ep = localStorage.getItem('v_ep');
            const key = localStorage.getItem('v_key');
            if(!ep || !key) return showConfig();

            const video = document.getElementById('video-stream');
            const canvas = document.getElementById('tempCanvas');
            canvas.width = 640;
            canvas.height = (640 / video.videoWidth) * video.videoHeight;
            canvas.getContext('2d').drawImage(video, 0, 0, canvas.width, canvas.height);
            const base64 = canvas.toDataURL('image/jpeg', 0.7).split(',')[1];

            document.getElementById('scanIndicator').classList.remove('hidden');
            document.getElementById('loadingOverlay').classList.remove('hidden');

            const prompt = currentMode === 'diet' 
                ? "è¯†åˆ«å›¾ä¸­é£Ÿç‰©ã€‚è¿”å›JSONæ ¼å¼ï¼š{\"type\":\"diet\",\"name\":\"é£Ÿç‰©å\",\"kcal_per_100g\":æ¯ç™¾å…‹çƒ­é‡,\"pro_per_100g\":è›‹ç™½è´¨,\"fat_per_100g\":è„‚è‚ª,\"est_weight\":AIé¢„æµ‹å›¾ä¸­å¤§æ¦‚å¤šå°‘å…‹}ã€‚ä¸è¦æ–‡å­—æè¿°ã€‚"
                : "è¯†åˆ«å›¾ä¸­å¥èº«å™¨æã€‚è¿”å›JSONï¼š{\"type\":\"workout\",\"name\":\"å™¨æå\",\"guide\":\"ç®€çŸ­æŒ‡å—\"}ã€‚";

            try {
                const response = await fetch('https://ark.cn-beijing.volces.com/api/v3/chat/completions', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${key}` },
                    body: JSON.stringify({
                        model: ep,
                        messages: [{ role: "user", content: [{ type: "text", text: prompt }, { type: "image_url", image_url: { url: "data:image/jpeg;base64," + base64 } }] }]
                    })
                });
                const data = await response.json();
                const content = data.choices[0].message.content;
                currentResult = JSON.parse(content.match(/\{.*?\}/s)[0]);
                
                // å¦‚æœæ˜¯é¥®é£Ÿæ¨¡å¼ï¼Œåˆå§‹åŒ–æ»‘å—
                if(currentResult.type === 'diet') {
                    const est = currentResult.est_weight || 200;
                    document.getElementById('weightSlider').value = est;
                    updateCalculatedKcal(est);
                }
                showPanel(currentResult);
            } catch (err) { alert("AI è¯†åˆ«å¼‚å¸¸ï¼Œè¯·æ£€æŸ¥é…ç½®"); }
            finally {
                document.getElementById('scanIndicator').classList.add('hidden');
                document.getElementById('loadingOverlay').classList.add('hidden');
            }
        }

        function updateCalculatedKcal(weight) {
            if(!currentResult || currentResult.type !== 'diet') return;
            document.getElementById('weightValue').innerHTML = `${weight}<small class="text-sm ml-1 opacity-50">g</small>`;
            
            // è®¡ç®—é€»è¾‘ï¼š(å•ä»· / 100) * é‡é‡
            const kcal = Math.round((currentResult.kcal_per_100g / 100) * weight);
            const pro = ((currentResult.pro_per_100g / 100) * weight).toFixed(1);
            const fat = ((currentResult.fat_per_100g / 100) * weight).toFixed(1);

            document.getElementById('resKcal').innerText = kcal;
            document.getElementById('resPro').innerText = pro + 'g';
            document.getElementById('resFat').innerText = fat + 'g';
            
            // æš‚å­˜å½“å‰è®¡ç®—åçš„å®Œæ•´ç»“æœä¾›ç¡®è®¤
            currentResult.final_weight = weight;
            currentResult.final_kcal = kcal;
        }

        function showPanel(data) {
            document.getElementById('resTitle').innerText = data.name;
            const isDiet = data.type === 'diet';
            document.getElementById('dietDetails').classList.toggle('hidden', !isDiet);
            document.getElementById('workoutDetails').classList.toggle('hidden', isDiet);
            if(!isDiet) document.getElementById('resGuide').innerText = data.guide;
            
            document.getElementById('resultPanel').classList.remove('hidden');
            setTimeout(() => document.getElementById('resultCard').style.transform = 'translateY(0)', 10);
        }

        function hidePanel() {
            document.getElementById('resultCard').style.transform = 'translateY(100%)';
            setTimeout(() => document.getElementById('resultPanel').classList.add('hidden'), 400);
        }

        function confirmEntry() {
            const entry = { ...currentResult, time: Date.now() };
            // å¦‚æœæ˜¯é¥®é£Ÿï¼Œä¿å­˜æœ€ç»ˆè®¡ç®—å€¼
            if(entry.type === 'diet') {
                entry.kcal = entry.final_kcal;
                entry.weight = entry.final_weight;
            }
            logs.push(entry);
            localStorage.setItem('ark_health_logs', JSON.stringify(logs));
            updateTotal();
            hidePanel();
            switchTab('log');
        }

        function renderLogs() {
            const container = document.getElementById('logContainer');
            container.innerHTML = logs.slice().reverse().map(l => `
                <div class="glass p-6 rounded-[32px] border-l-4 ${l.type === 'diet' ? 'border-green-500' : 'border-blue-500'}">
                    <div class="flex justify-between items-start">
                        <div>
                            <div class="text-xl font-bold italic">${l.name}</div>
                            <div class="text-[9px] opacity-30 mt-1 uppercase">${new Date(l.time).toLocaleString()}</div>
                        </div>
                        <div class="text-right">
                            ${l.type === 'diet' ? 
                                `<div class="text-green-400 font-black">+ ${l.kcal} kcal</div><div class="text-[9px] opacity-40">${l.weight}g</div>` : 
                                `<span class="text-blue-400 text-[10px] font-bold">GYM</span>`}
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function updateTotal() {
            const goal = parseInt(localStorage.getItem('v_goal') || "2000");
            const intake = logs.filter(l => l.type === 'diet' && new Date(l.time).toDateString() === new Date().toDateString())
                               .reduce((s, i) => s + (Number(i.kcal) || 0), 0);
            document.querySelectorAll('.totalKcal').forEach(el => el.innerText = intake);
            document.getElementById('remainKcal').innerText = Math.max(0, goal - intake);
        }

        function switchTab(tab) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.tab-item').forEach(t => t.classList.remove('active'));
            document.getElementById(tab + 'Page').classList.add('active');
            document.getElementById('tab-' + tab).classList.add('active');
            if(tab === 'log') renderLogs();
        }

        function showConfig() { document.getElementById('configPanel').classList.remove('hidden'); }
        function saveSettings() {
            localStorage.setItem('v_ep', document.getElementById('epInput').value.trim());
            localStorage.setItem('v_key', document.getElementById('keyInput').value.trim());
            localStorage.setItem('v_goal', document.getElementById('goalInput').value || "2000");
            document.getElementById('configPanel').classList.add('hidden');
            initCamera();
            updateTotal();
        }

        window.onload = () => {
            document.getElementById('epInput').value = localStorage.getItem('v_ep') || "";
            document.getElementById('keyInput').value = localStorage.getItem('v_key') || "";
            document.getElementById('goalInput').value = localStorage.getItem('v_goal') || "2000";
            if(localStorage.getItem('v_ep')) initCamera(); else showConfig();
            updateTotal();
        }
    </script>
</body>
</html>
